@using Booking_Backend.Data.Enums;
@model DetailViewModel
@inject LazZiya.ExpressLocalization.ISharedCultureLocalizer _loc;
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@inject Microsoft.Extensions.Configuration.IConfiguration Configuration;
@{
    var culture = CultureInfo.CurrentCulture.Name;
}
@{
    ViewData["Title"] = "Trang chi tiết";
    Layout = "_Layout";
}

@section IndexStyle {
    <link rel="stylesheet" href="~/style/hotel/detail.css">
}
    <div class="container " style="padding-top: 70px">
        <div class="row main-page">
             <div class="col-md-3 main-page-content left-bar">
            <div class="searchbox-layout-vertical pl-3 pr-3 pb-3 pt-0" style="height: 504px; border-color: white; background-color: #ffb700">
                    <h4 class="pb-0">Tìm theo</h4>
                    <div>
                        <div class="pl-2" style="font-weight:300; font-size: 11px">Địa điểm</div>
                        <input class="form-control" val placeholder="Địa chỉ" />
                    </div>
                    <div class="mt-1">
                        <div class="pl-2" style="font-weight:300; font-size: 11px">Ngày nhận phòng</div>
                    <input type="text" class="form-control" value="@ViewData["check-in"]" placeholder="Địa chỉ" />
                    </div>  
                    <div class="mt-1">
                    <div class="pl-2" style="font-weight:300; font-size: 11px">Ngày trả phòng</div>
                    <input type="text" value="@ViewData["check-out"]" class="form-control" placeholder="Địa chỉ" />
                    </div>    
                    <div class="mt-1">
                    <div class="pl-2" style="font-weight:300; font-size: 11px">Số người</div>
                    <input type="number" class="form-control" value="@ViewData["people"]" />
                    </div>
                    <button class="btn btn-primary mt-2" style="width: 100%">Tìm ngay</button>
                    <div class="mt-3" style="height: 150px">






                    <div id="map" style="height: 100%; width: 100%"></div>

                    <!--
                      The `defer` attribute causes the callback to execute after the full HTML
                      document has been parsed. For non-blocking uses, avoiding race conditions,
                      and consistent behavior across browsers, consider loading using Promises.
                      See https://developers.google.com/maps/documentation/javascript/load-maps-js-api
                      for more information.
                      -->
                    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCyYgiP09op4gI41iF5BDNUwyz0vPRPHSw&callback=initMap&v=weekly"
                            defer></script>










                    </div>
                </div>
            </div> 
            <div class="col-md-9 main-page-content main-content">
                <div class="info-layout-full">
                    <h4>@Model.HotelDetail.HotelTranslations.FirstOrDefault().Name</h4>
                    <div class="info-title-hotel">
                        <a href=""><i class="bi bi-pin-map-fill"></i></a>
                    <p>@Model.HotelDetail.HotelTranslations.FirstOrDefault().Area - @Model.HotelDetail.HotelTranslations.FirstOrDefault().Address - </p>
                        <a href="#">
                            <div localize-content> Hiển thị bản đồ</div>
                        </a>
                    </div>
                    <div class="list-img-hotel">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="row pb-2">
                                    <div class="col-md-12 pr-2">
                                    @if (Model.HotelDetail.Images.Count >= 1)
                                    {
                                        <img src="@(Configuration["HostServer"] + Model.HotelDetail.Images[0].ImageUrl)" alt="" class="img-1-1">
                                    } else
                                    {
                                        <img src="" alt="" class="img-1-1">
                                    }
                                </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12 pr-2">
                                    @if (Model.HotelDetail.Images.Count  >= 2)
                                    {
                                        <img src="@(Configuration["HostServer"] + Model.HotelDetail.Images[1].ImageUrl)" alt="" class="img-1-2">
                                    }
                                    else
                                    {
                                        <img src="" alt="" class="img-1-2">
                                    }
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-8 pl-0">
                            @if (Model.HotelDetail.Images.Count >= 3)
                            {
                                <img src="@(Configuration["HostServer"] + Model.HotelDetail.Images[2].ImageUrl)" alt="" class="img-2">
                            }
                            else
                            {
                                <img src="" alt="" class="img-2">
                            }
                            </div>
                        </div>
                        <div class="row list-thimbnail">
                        @{
                            if (Model.HotelDetail.Images.Count>=3)
                            {
                                int startIndex = 3; // Bắt đầu từ phần tử thứ 4
                                for (int i = startIndex; i < Model.HotelDetail.Images.Count; i++)
                                {
                                                <div class="col-md-2 card-img-3 pr-1 pl-1">
                                                    @if(Model.HotelDetail.Images[i].ImageUrl != null) {
                                                        <img style="height: 100px" src="@(Configuration["HostServer"] + Model.HotelDetail.Images[i].ImageUrl)" alt="">
                                        } else
                                        {
                                                        <img style="height: 100px" src="" alt="">
                                        }
                                                </div>
                                }
                            }
                        }
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row feature-extension pb-5">
            <div class="col-md-12">
                <div class="row pb-3">
                @foreach(var item in Model.ServiceHotels)
                {
                    <div class="col-md-2 extension-item pr-3 pl-0 mt-2">
                        <div>@item.Name</div>
                    </div>
                }
                </div>
            </div>
        </div>
    <div class="row description-hotel">
        <div class="col-md-9">
            <div class="description-content">
                @Model.HotelDetail.HotelTranslations.FirstOrDefault().Description
            </div>
        </div>
        <div class="col-md-3">
            <form id="formAddToCart" action="/cart/addtocart" method="post">
                <div class="card-checksave">
                    <input type="hidden" value="@Model.HotelDetail.Id" name="HotelId" />
                    @if(Model.UserClient != null)
                    {
                        <input type="hidden" value="@Guid.Parse(Model.UserClient.ResultOject.Id)" name="UserId" />
                    }
                    <div class="pb">Bạn chưa có quyết định ?</div>
                    <div class="p-2" style="font-weight: 300; font-size: 13px">@Model.HotelDetail.HotelTranslations.FirstOrDefault().ShortDescription</div>
                    <div class="btn-savehotel">
                        <input id="addToCart" type="submit" value="Lưu chỗ nghỉ">
                    </div>
                </div>
            </form>
        </div>

        </div>
        <div class="row show-room">
            <h3>Phòng trống</h3>
           
            <div class="room-list pt-3">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th class="col-md-2">Loại chỗ nghỉ</th>
                            <th class="col-md-2">Tiện ích phòng</th>
                            <th class="col-md-1">SL khách</th>
                            <th class="col-md-2">Giá hôm nay</th>
                            <th class="col-md-1">Còn trống</th>
                            <th class="col-md-2"></th>
                        </tr>
                    </thead>
                <tbody class="room-detail-body">
                    @foreach(var item in Model.Rooms)
                    {
                        <form method="post" asp-controller="Booking" asp-action="ConfirmInfo" asp-route-culture="@culture">
                            <tr>
                                @if (Model.HotelDetail.Images.Count >= 1)
                                {
                                <input type="hidden" value="@Model.HotelDetail.Images[0].ImageUrl" name="ThumbnailHotel" />
                                }
                                else
                                {
                                <input type="hidden" value="/" name="ThumbnailHotel" />
                                }
                                <input type="hidden" name="RoomId" value="@item.Id"/>
                                <input type="hidden" name="HotelId" value="@Model.HotelDetail.Id"/>
                                <td>
                                    <input type="hidden" name="HotelName" value="@Model.HotelDetail.HotelTranslations.FirstOrDefault().Name" />
                                    <input type="hidden" name="Address" value="@Model.HotelDetail.HotelTranslations.FirstOrDefault().Address" />
                                    <input type="hidden" name="Hotline" value="@Model.HotelDetail.Hotline" />
                                    <a href="">@item.RoomType.RoomTypeTranslations.FirstOrDefault().Name</a>
                                    <input type="hidden" name="RoomTypeName" value="@item.RoomType.RoomTypeTranslations.FirstOrDefault().Name" />
                                    <div style="font-size: 15px">@item.Bed.BedTranslations.FirstOrDefault().Name</div>
                                    <input type="hidden" name="BedName" value="@item.Bed.BedTranslations.FirstOrDefault().Name" />
                                    <br>
                                    <span class="description-room-item">Mô tả loại giường: </span>
                                    <p class="desroom-content">
                                        @item.Bed.BedTranslations.FirstOrDefault().Description    
                                    </p>
                                </td>
                                <td>
                                    @foreach (var extension in item.Room_Extensions)
                                    {
                                        <div style="font-weight: 300; font-size: 14px" class="extenname-item">
                                            - @if(extension.Extension.ExtensionTranslations.Count > 0)
                                            {
                                                <text>@extension.Extension.ExtensionTranslations.FirstOrDefault().Name</text>
                                            }
                                        </div>
                                    }    
                                </td>
                                <td>@item.Maximum</td>
                                <td style="font-size: 25px;">
                                    <input type="hidden" name="Price" value="@item.PriceOverNight" />
                                    @item.PriceOverNight.ToString("N0") <span>VND</span>
                                        <div class="VAT-room">Đã bao gồm thuế và phí</div>
                                </td>
                                <td class="d-flex justify-content-center" style="border: none; border-top: thin solid #ccc">
                                    <div class=" d-flex align-items-center justify-content-center" style="font-size: 20px; border: thin solid #ccc; height:45px; width: 60px; background-color: #f7f3f3;">
                                        @(item.Status == StatusRoom.Empty?1:0)
                                    </div>
                                </td>
                                <td class="column-result">
                                    <select name="RoomQuality" class="form-control">
                                        @if(item.Status == StatusRoom.Empty)
                                        {
                                            <option value="0">0</option>
                                            <option value="1">1</option>
                                        }else
                                        {
                                        <option value="0">0</option>
                                        }
                                    </select>
                                    @if(item.Status == StatusRoom.Empty)
                                    {
                                        <span style="color:blue; font-weight:300; font-size:15px">Chúng tôi còn 1 phòng trống</span>
                                    }      else
                                    {
                                        <span style="color:red; font-weight:300; font-size:15px">Chúng tôi đã hết phòng trống</span>
                                    }
                                    <h4 class="pt-3"><span class="total-price">0</span>VND </h4>
                                    <p style="font-weight: 300; font-size: 14px">Đã bao gồm thuế</p>
                                    @if(item.Status==StatusRoom.Empty)
                                    {
                                        <input type="submit" value="Tôi sẽ đặt" style="width: 100%" class="btn btn-primary">
                                    }else
                                    {
                                        <input disabled type="submit" value="Đã bán hết" style="width: 100%" class="btn btn-outline-primary">
                                    }
                                    <p class="pt-2" style="font-weight: 300; font-size: 14px">
                                        * Bạn sẽ được chuyển đến bước
                                        kế tiếp
                                    </p>
                                </td>
                            </tr>
                        </form>
                    }
                    </tbody>
                </table>
            </div>
        </div>
        <div class="mt-3 comment-container" style="border: thin solid #ccc" >
        @if (Model.UserClient != null)
        {
            <form method="post" asp-action="create" asp-controller="comment">
                <div class="row p-3">
                    <div class="col-md-1">
                        <div class="wrapper-avatar justify-content-center d-flex">
                            @if(Model.UserClient.ResultOject.AvatarUrl != "")
                            {
                                <img src="@(Configuration["HostServer"] + Model.UserClient.ResultOject.AvatarUrl)" style="height: 60px; width:60px" />

                            }  else
                            {
                                <img src="/img/user-profile-icon-trendy-flat-260nw-1923506948.png" style="height: 60px; width:60px" />

                            }
                        </div>
                    </div>
                    <div class="col-md-7">
                        <input type="hidden" name="UserId" value="@Model.UserClient.ResultOject.Id" />
                        <input type="hidden" name="HotelId" value="@Model.HotelDetail.Id" />
                        <div class="wrapper-content-comment">
                            <textarea name="Content" class="content-comment p-2" style="width: 100%;outline: none; border: thin solid #ccc"></textarea>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary">Bình luận</button>
                    </div>
                </div>
            </form>
        }   else
        {
            <form method="post">
                <div class="row p-3">
                    <div class="col-md-1">
                        <div class="wrapper-avatar justify-content-center d-flex">
                            <img src="/img/logo/avatar-trang-4.jpg" style="height: 60px; width:60px" />
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div class="wrapper-content-comment">
                            <x readonly class="content-comment p-2" style="width: 100%;outline: none">
                            Hãy đăng nhập để có thể bình luận!
                            </x>
                        </div>
                    </div>
                </div>
            </form>
        }
        @foreach(var item in Model.GetAllCommentByHotelId)
        {
            <hr class="m-0"/>
            <div class="comment-item p-3">
                <div class="row">
                    <div class="col-md-1">
                        <img class="ml-4" src="@(Configuration["HostServer"] + item.User.UserImages.FirstOrDefault().ImageUrl)" style="height: 40px; width: 40px; border-radius: 50%" />
                    </div>
                    <div class="col-md-8">
                        <form method="post" action="/comment/update/@item.Id">
                            <input type="hidden" name="HotelId" value="@Model.HotelDetail.Id"/>
                            <div class="username-comment" style="color: blue">@item.User.DisplayName - <span style="color:black; font-weight: 300; font-size: 13px">@item.Created</span></div>
                            <div>
                                <input readonly id="txtCommentContent_@(item.Id)" name="Content" class="content-comment form-control" style="background-color: white; border: none; font-size: 13px; font-weight: 300" value="@item.Content" />
                            </div>
                            <button data-like=@item.Id id="btnLike_@(item.Id)" class="btnLike btn btn-outline-danger mt-2" style="font-size: 13px; display: none"><i class="bi bi-heart-fill"></i></button>
                            <button data-like=@item.Id id="btnUnLike_@(item.Id)" class="btnUnLike btn btn-outline-danger mt-2" style="font-size: 13px;"><i class="bi bi-heart"></i></button>

                            @if(Model.UserClient != null && Model.UserClient.ResultOject.Id == item.User.Id.ToString())
                            {
                                <button id="btnUpdate" data-comment-id="@(item.Id)" class="btn btn-outline-primary mt-2" style="font-size: 13px;"><i class="bi bi-pencil-square"></i></button>
                                <button id="btnConfirm" type="submit" class="btn btn-primary mt-2" style="display: none; font-size: 13px;"><i class="bi bi-check-lg"></i></button>
                                <a href="/comment/delete/@item.Id/@Model.HotelDetail.Id"><div id="btnDelete" class="btn btn-danger mt-2" style="font-size: 13px;"><i class="bi bi-trash3"></i></div></a>
                                <button id="btnCancel" class="btn btn-danger mt-2" style="font-size: 13px; display: none"><i class="bi bi-x-circle"></i></button>
                            }
                        </form>
                    </div>
                </div>
            </div>       
        }
    </div>
</div>
<script>


    function initMap() {
        const uluru = {
            lat: @Html.Raw(Json.Serialize(Model.HotelDetail.Latitude)), lng: @Html.Raw(Json.Serialize(Model.HotelDetail.Longitude)) };
        const map = new google.maps.Map(document.getElementById("map"), {
            zoom: 15,
            center: uluru,
        });
        // Thêm sự kiện 'click' vào bản đồ
        map.addListener("click", (event) => {
            // Lấy tọa độ khi click
            const clickedLocation = event.latLng;
            // Lấy vĩ độ và kinh độ
            const latitude = clickedLocation.lat();
            const longitude = clickedLocation.lng();
            // In ra console
            console.log("Vĩ độ:", latitude);
            console.log("Kinh độ:", longitude);
        });
        const contentString = '@Model.HotelDetail.HotelTranslations.FirstOrDefault().Address'
        const infowindow = new google.maps.InfoWindow({
            content: contentString,
            ariaLabel: "Uluru",
        });
        const marker = new google.maps.Marker({
            position: uluru,
            map,
            title: "Uluru (Ayers Rock)",
        });

        marker.addListener("click", () => {
            infowindow.open({
                anchor: marker,
                map,
            });
        });
    }

    window.initMap = initMap;


    var addToCart = document.getElementById("addToCart");
    var formAddToCart = document.getElementById("formAddToCart");
    addToCart.addEventListener("click", (e) => {
        e.preventDefault()
        Swal.fire({
            title: "Xác nhận thêm vào giỏ hàng!",
            text: "Lưu trữ giỏ hàng để đặt sau",
            icon: "info",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "Có, tôi đồng ý"
        }).then((result) => {
            if (result.isConfirmed) {
                    formAddToCart.submit()
            }
        });
    })
    var
    btnUpdate = document.getElementById("btnUpdate");
    var btnDelete = document.getElementById("btnDelete");
    var btnCancel = document.getElementById("btnCancel");
    var btnConfirm = document.getElementById("btnConfirm");
    var btnLikes = document.querySelectorAll(".btnLike");
    var btnUnLikes = document.querySelectorAll(".btnUnLike")
    btnUpdate.addEventListener("click", function () {
        event.preventDefault()
        var commentId = this.getAttribute("data-comment-id");
        var txtCommentContent = document.getElementById("txtCommentContent_" + commentId);
        txtCommentContent.removeAttribute("readonly");
        txtCommentContent.focus()
        btnDelete.style.display = "none"
        btnUpdate.style.display = "none"
        btnCancel.style.display = "inline-block"
        btnConfirm.style.display = "inline-block"
    });  
    btnCancel.addEventListener("click", function () {
        event.preventDefault()

        var commentId = this.getAttribute("data-comment-id");
        var txtCommentContent = document.getElementById("txtCommentContent_" + commentId);
        btnCancel.style.display = "none"
        btnDelete.style.display = "inline-block"
        btnConfirm.style.display = "none"
        btnUpdate.style.display = "inline-block"
    });   
    btnLikes.forEach(function (btnLike) {
        btnLike.addEventListener("click", function () {
            event.preventDefault()

            var commentId = this.getAttribute("data-like");
            var btnUnLike = document.getElementById("btnUnLike_" + commentId);
            var btnLike = document.getElementById("btnLike_" + commentId);

            btnLike.style.display = "none";
            btnUnLike.style.display = "inline-block";

            // Thực hiện các hành động khác khi người dùng thả tim
        });
    });

    btnUnLikes.forEach(function (btnUnLike) {
        btnUnLike.addEventListener("click", function () {
            event.preventDefault()

            var commentId = this.getAttribute("data-like");
            var btnUnLike = document.getElementById("btnUnLike_" + commentId);
            var btnLike = document.getElementById("btnLike_" + commentId);

            btnLike.style.display = "inline-block";
            btnUnLike.style.display = "none";

            // Thực hiện các hành động khác khi người dùng không thả tim
        });
    });
</script>